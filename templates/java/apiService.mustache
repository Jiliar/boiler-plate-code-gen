package {{packageName}};

import {{domain_ports_input}}.{{operationName}}UseCase;
import {{domain_ports_output}}.{{entityName}}RepositoryPort;
import {{application_dto}}.*;
import {{domain_model}}.{{entityName}};
import {{application_mapper}}.{{entityName}}Mapper;
import {{infra_config_exceptions}}.NotFoundException;
import {{utils}}.LoggingUtils;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;{{#operationName}}
{{#isListOperation}}
import java.util.List;
import java.math.BigDecimal;{{/isListOperation}}
{{/operationName}}

/**
 * Application service implementing {{operationName}} use case.
 * <p>
 * This service contains the business logic for {{operationName}} operation,
 * orchestrating domain objects and repository interactions. It serves as
 * the application layer in Clean Architecture, implementing use case interfaces
 * defined in the domain layer.
 * </p>
 * 
 * @author {{author}}
 * @version {{version}}
 */
@Service
@RequiredArgsConstructor
@Transactional
public class {{classname}} implements {{operationName}}UseCase {

    private static final LoggingUtils logger = LoggingUtils.getLogger({{classname}}.class);
    
    private final {{entityName}}RepositoryPort {{entityVarName}}RepositoryPort;
    private final {{entityName}}Mapper {{entityVarName}}Mapper;

    {{#isUpdate}}
    @Override
    public {{returnType}} execute(String userId, {{requestType}} request) {
        logger.info("Executing {{operationName}} with userId: {} and request: {}", userId, request);
        
        try {
            {{entityName}} existing{{entityName}} = {{entityVarName}}RepositoryPort.findById(userId)
                .orElseThrow(() -> new NotFoundException("{{entityName}} not found"));
            
            // Update existing entity with request data
            {{entityName}} updated{{entityName}} = {{entityVarName}}Mapper.fromUpdateRequest(request);
            updated{{entityName}}.setUserId(userId);
            updated{{entityName}}.setUsername(existing{{entityName}}.getUsername());
            updated{{entityName}}.setCreatedAt(existing{{entityName}}.getCreatedAt());
            updated{{entityName}}.setStatus(existing{{entityName}}.getStatus());
            
            {{entityName}} saved{{entityName}} = {{entityVarName}}RepositoryPort.save(updated{{entityName}});
            logger.info("{{entityName}} updated successfully with ID: {}", userId);
            
            return {{entityVarName}}Mapper.toUpdateResponse(saved{{entityName}});
        } catch (NotFoundException e) {
            logger.error("{{entityName}} not found in {{operationName}}", e, userId);
            throw e;
        } catch (Exception e) {
            logger.error("Error in {{operationName}}", e, userId);
            throw e;
        }
    }
    {{/isUpdate}}
    {{^isUpdate}}
    @Override
    public {{returnType}} execute({{requestType}} request) {
        logger.info("Executing {{operationName}} with request: {}", request);
        
        try {
            {{#isCreate}}
            // Convert request to domain model using mapper
            {{entityName}} {{entityVarName}} = {{entityVarName}}Mapper.fromCreateRequest(request);
            
            {{entityName}} saved{{entityName}} = {{entityVarName}}RepositoryPort.save({{entityVarName}});
            logger.info("{{entityName}} created successfully with ID: {}", saved{{entityName}}.getUserId());
            
            return {{entityVarName}}Mapper.toCreateResponse(saved{{entityName}});
            {{/isCreate}}
            {{#isGet}}
            {{entityName}} {{entityVarName}} = {{entityVarName}}RepositoryPort.findById(request)
                .orElseThrow(() -> new NotFoundException("{{entityName}} not found"));
            
            logger.info("{{entityName}} retrieved successfully with ID: {}", request);
            return {{entityVarName}}Mapper.toGetResponse({{entityVarName}});
            {{/isGet}}
            {{#isDelete}}
            // Verify user exists before deletion
            {{entityName}} {{entityVarName}} = {{entityVarName}}RepositoryPort.findById(request)
                .orElseThrow(() -> new NotFoundException("{{entityName}} not found"));
            
            {{entityVarName}}RepositoryPort.deleteById(request);
            logger.info("{{entityName}} deleted successfully with ID: {}", request);
            
            return {{returnType}}.builder()
                .deleted(true)
                .message("{{entityName}} deleted successfully")
                .build();
            {{/isDelete}}
            {{^isCreate}}{{^isGet}}{{^isDelete}}
            // List operation
            List<{{entityName}}> {{entityVarName}}s = {{entityVarName}}RepositoryPort.findAll();
            
            // Build the list response manually
            List<{{entityName}}Response> responseList = {{entityVarName}}Mapper.toResponseList({{entityVarName}}s);
            logger.info("Retrieved {} {{entityVarName}}s successfully", {{entityVarName}}s.size());
            
            return {{returnType}}.builder()
                .users(responseList)
                .page(BigDecimal.valueOf(1))
                .size(BigDecimal.valueOf({{entityVarName}}s.size()))
                .total(BigDecimal.valueOf({{entityVarName}}s.size()))
                .totalPages(BigDecimal.valueOf(1))
                .build();
            {{/isDelete}}{{/isGet}}{{/isCreate}}
        } catch (NotFoundException e) {
            logger.error("{{entityName}} not found in {{operationName}}", e, request);
            throw e;
        } catch (Exception e) {
            logger.error("Error in {{operationName}}", e, request);
            throw e;
        }
    }
    {{/isUpdate}}
}